clc
close all
clear all
addpath('../../matlab')

dim=3;
numPlanes=2;
forceDegenerate=0;

N=rand(dim,numPlanes);
P=rand(dim,numPlanes);

if forceDegenerate
N(:,end)=N(:,1);
P(:,end)=P(:,1);
end

x=rand(dim,1);

inputFileName=[pwd '/build/inputFile.txt'];
outputFileName=[pwd '/build/outputFile.txt'];

fID=fopen(inputFileName,'w');
fprintf(fID,['dim=' num2str(dim) '; \n']);
fprintf(fID,['numPlanes=' num2str(numPlanes) '; \n']);
printMatrix(fID,'N',N);
printMatrix(fID,'P',P);
printMatrix(fID,'x',x);
fclose(fID)

%% 
system(['build/test ' inputFileName ' ' outputFileName])
outData=load(outputFileName)
success=outData(1);
snappedPoint=outData(1);


%return



%% Plot planes as circles
theta=[0:100]/100*2*pi;
figure(1)
hold on
for k=1:numPlanes
    plotCircle3(P(:,k),N(:,k),10,theta);
end

%% Sep up solution in MATLAB FOR COMPARISON
%A=N'*N;
b=zeros(numPlanes,1);
for k=1:numPlanes
b(k)=dot(N(:,k),(x-P(:,k)));
end

%[U,S,V] = reducedSVD(A,1e-7);
[U,S,V] = reducedSVD(N,1e-7);


%lam=V*diag(1./diag(S))*U'*b;
lam=V*diag(1./diag(S).^2)*V'*b;


x1=x-N*lam;
% for k=1:numPlanes 
%     x1=x1-lam(k)*N(:,k);
% end

plot3(x1(1),x1(2),x1(3),'og')
plot3(x(1),x(2),x(3),'sm')
plot3(data(1),x(2),x(3),'sm')


for k=1:numPlanes 
    plot3([x(1) x1(1)],[x(2) x1(2)],[x(3) x1(3)])
end

axis image

function printMatrix(fID,name,m)
fprintf(fID,[name '=']);
for k=1:size(m,1)
fprintf(fID,'%1.15f',m(k,:));
if k<size(m,1)
fprintf(fID,'\n');
else
    fprintf(fID,';\n');
end
end
end

function [Ur,Sr,Vr]=reducedSVD(A,tol)
[U,S,V] = svd(A);
r=sum(abs(diag(S))>tol)
Ur=U(:,[1:r]);
Sr=S([1:r],[1:r]);
Vr=V(:,[1:r]);
end

function plotCircle3(P,n,r,theta)
n=n/norm(n);
b=cross(n,rand(size(n)));

while norm(b) < 1e-7
b=cross(n,rand(size(n)));
end
b=b/norm(b);
x=zeros(size(P,1),length(theta));
for(t=1:length(theta))
    x(:,t)=P+angleAxis(n,theta(t))*b;
end
    plot3(x(1,:),x(2,:),x(3,:))
end